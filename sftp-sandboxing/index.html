<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>sftp sandboxing</title>
    <meta name="description" content="unix sure is a system">
    <meta name="author" content="jyn">

    <link rel="alternate" type="application/atom+xml" title="the website of jyn" href="/atom.xml">
    <link rel="icon" type="image/x-icon" href="https://jyn.dev/favicon.jpg">
    <script src="/main.js?v=wvtZiifuphFXrUx&#x2F;AZPby7lFReedssGrex4iXTQVPxDX5pADGkCUoT7Z3AHQD2sE" defer></script>
    <link rel="stylesheet" href="https://jyn.dev/minima.css?v=PbArlSoyRf+X9Tyb3lhhFoVxQSXIbhQdDcqszhAQQHbQWoYLtrcqLij&#x2F;46wgTFlJ">
</head>
<body>
      <header class="site-header" role="banner">

      <div class="wrapper">
        <a class="site-title" href="/">the website of jyn</a>

        
        
          <nav class="site-nav">
            <input type="checkbox" id="nav-trigger" class="nav-trigger" />
            <label for="nav-trigger">
              <span class="menu-icon">
                <svg viewBox="0 0 18 15" width="18px" height="15px">
                  <title>menu</title>
                  <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
                  <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
                  <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
                </svg>
              </span>
            </label>

            <div class="trigger">
              
                
                
                <a class="page-link" href="&#x2F;about&#x2F;">about</a>
                
              
                
                
              
                
                
                <a class="page-link" href="&#x2F;talks&#x2F;">talks</a>
                
              
                <a class="page-link" href="/computer-of-the-future">the computer of the next 200 years</a>
            </div>
          </nav>
        
      </div>
    </header>

    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
		<h1 title="unix sure is a system" class="post-title" itemprop="name headline">sftp sandboxing</h1>
    <p class="post-meta">
      <time datetime="2025-05-05" itemprop="datePublished">
        2025-05-05
      </time>
      
      
      
        
        
      â€¢ <a href="https://jyn.dev/tags/walkthroughs/">walkthroughs</a>
        
      
    </p>
  </header>

  

	

  
    

  <div class="post-content" itemprop="articleBody">
    <p>consider the following problem:</p>
<ul>
<li>you want to share a 300 MB directory</li>
<li>with a single other person, not publicly</li>
<li>over a public network</li>
</ul>
<p>any hosting service that lets you serve 300 MB costs money. also, for sufficient file sizes the wasted upload becomes noticeable. it would be much nicer if we could peer-to-peer this.</p>
<p>sftp to the rescue!</p>
<p>small problem: sftp shows you a <em>lot</em> of the system state. for one thing, you have read access to basically every file on the system, and write access to anything owned by your user. for another, the easiest way to set up sftp is through an ssh server, which is. well. it has "shell" in the name for a reason.</p>
<p>so! here is how to set up a read-only sftp server which doesn't allow any other kind of access.</p>
<p>First, add the following to <code>/etc/ssh/sshd_config</code>:</p>
<pre data-lang="sshd" class="language-sshd z-code"><code class="language-sshd" data-lang="sshd"><span class="z-text z-plain">Subsystem       sftp    internal-sftp
</span><span class="z-text z-plain">Match User myuser
</span><span class="z-text z-plain">	ChrootDirectory %h
</span><span class="z-text z-plain">	ForceCommand internal-sftp -R
</span><span class="z-text z-plain">	DisableForwarding yes
</span></code></pre>
<p>Then run the following commands in a root shell (e.g. with <code>sudo -i</code>):</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">mkdir</span></span><span class="z-meta z-function-call z-arguments z-shell"> /empty</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">chmod</span></span><span class="z-meta z-function-call z-arguments z-shell"> a-w /empty</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">useradd</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>s</span> /usr/sbin/nologin<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>m</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>skel</span> /empty myuser</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">chown</span></span><span class="z-meta z-function-call z-arguments z-shell"> root:root /home/myuser</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">chmod</span></span><span class="z-meta z-function-call z-arguments z-shell"> a+rx /home/myuser</span>
</span></code></pre>
<p>Finally, create <code>/home/myuser/.ssh/authorized_keys</code> in any way you wish</p>
<p>This creates a sftp session that looks like this:</p>
<pre class="z-code"><code><span class="z-text z-plain">$ ssh myuser@localhost
</span><span class="z-text z-plain">This service allows sftp connections only.
</span><span class="z-text z-plain">Connection to localhost closed.
</span><span class="z-text z-plain">$ sftp myuser@localhost
</span><span class="z-text z-plain">Connected to localhost.
</span><span class="z-text z-plain">sftp&gt; pwd
</span><span class="z-text z-plain">Remote working directory: /
</span><span class="z-text z-plain">sftp&gt; ls
</span><span class="z-text z-plain">myfile
</span><span class="z-text z-plain">sftp&gt; ls ..
</span><span class="z-text z-plain">../myfile
</span><span class="z-text z-plain">sftp&gt; ls ../../..
</span><span class="z-text z-plain">../../../myfile
</span><span class="z-text z-plain">sftp&gt; mkdir x
</span><span class="z-text z-plain">remote mkdir &quot;/x&quot;: Permission denied
</span><span class="z-text z-plain">sftp&gt; chmod 644	myfile
</span><span class="z-text z-plain">Changing mode on /myfile
</span><span class="z-text z-plain">remote setstat &quot;/myfile&quot;: Permission denied
</span><span class="z-text z-plain">sftp&gt; get myfile
</span><span class="z-text z-plain">Fetching /myfile to myfile
</span><span class="z-text z-plain">myfile       100%   46MB 899.5MB/s   00:00
</span></code></pre>
<hr />
<p>Some explanations and references:</p>
<p><a href="https://man.openbsd.org/cgi-bin/man.cgi/OpenBSD-current/man5/sshd_config.5#Subsystem"><code>Subsystem</code></a> is documented as follows:</p>
<blockquote>
<p>Configures an external subsystem (e.g. file transfer daemon). [...] the name <code>internal-sftp</code> implements an in-process SFTP server. [...] It accepts the same command line arguments as <code>sftp-server</code> [...]</p>
</blockquote>
<p>what arguments can we pass to <a href="https://man.openbsd.org/sftp-server#R"><code>sftp-server</code></a>?</p>
<blockquote>
<p><code>-R</code>	Places this instance of <code>sftp-server</code> into a read-only mode. Attempts to open files for writing, as well as other operations that change the state of the filesystem, will be denied.</p>
</blockquote>
<p>just what we want!</p>
<p><a href="https://man.openbsd.org/cgi-bin/man.cgi/OpenBSD-current/man5/sshd_config.5#ForceCommand"><code>ForceCommand internal-sftp</code></a> is a cute little feature of openssh:</p>
<blockquote>
<p>Specifying a command of <code>internal-sftp</code> will force the use of an in-process SFTP server that requires no support files when used with <code>ChrootDirectory</code>.</p>
</blockquote>
<p>In particular, this denies shell and command access.</p>
<p>What is <code>ChrootDirectory</code>?</p>
<blockquote>
<p>Specifies the pathname of a directory to <a href="https://man.openbsd.org/chroot.2">chroot(2)</a> to after authentication. At session startup <a href="https://man.openbsd.org/sshd.8">sshd(8)</a> checks that all components of the pathname are root-owned directories which are not writable by group or others. After the chroot, <a href="https://man.openbsd.org/sshd.8">sshd(8)</a> changes the working directory to the user's home directory. [...] For file transfer sessions using SFTP no additional configuration of the environment is necessary if the in-process sftp-server is used [...]</p>
</blockquote>
<p>cute! an easy way to deny even reading other parts of the rest of the system.</p>
<p>why does it require the path to be owned by root? <a href="https://lists.mindrot.org/pipermail/openssh-unix-dev/2009-May/027651.html">https://lists.mindrot.org/pipermail/openssh-unix-dev/2009-May/027651.html</a></p>
<blockquote>
<p>If you ever let the user chroot to this directory and execute his
hard-linked /bin/su, he can become root within that directory and then
escape the chroot. Even if you could prevent him from escaping chroot,
he can create device nodes and operate directly on filesystems, mount
/proc and operate on external processes, etc. It should be clear that
this is Very Bad (tm).</p>
</blockquote>
<p>cool cool cool. love unix. this sure is a tool we use to build software.</p>
<p><a href="https://man.openbsd.org/cgi-bin/man.cgi/OpenBSD-current/man5/sshd_config.5#Match"><code>Match</code></a> is surprisingly complicated in the general case but simple enough here.
<a href="https://man.openbsd.org/cgi-bin/man.cgi/OpenBSD-current/man5/sshd_config.5#DisableForwarding"><code>DisableForwarding</code></a> is probably not <em>strictly</em> necessary but we don't want people using this file server as a jumpbox to whatever other networks it's connected to, nor as e.g. a tor exit node.</p>
<p>lastly i want to point out that <code>useradd</code> by default creates a user with no login password, which takes care of people guessing passwords for this without the proper ssh public key. i have <code>PasswordAuthentication no</code> set in <code>sshd_config</code>, but this allows disabling the password for just your sftp access without disabling it altogether. alternatively you could put it under the <code>Match User</code>.</p>
<hr />
<p><strong>NOTE:</strong> an earlier version of this post suggested <code>Subsystem sftp internal-sftp -R</code> and <code>ForceCommand internal-sftp</code>. that disables write access for <em>all</em> users, not just the selected user. the new version only disables it for the selected user.</p>

  </div>
</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading"><a href="https://jyn.dev">the website of jyn</a></h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
            
            <li><a href="mailto:blog@jyn.dev">blog@jyn.dev</a></li>
            
            
            <li><a href="https://jyn.dev/assets/Resume.pdf">Resume</a>

        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/jyn514"><span class="icon icon--github"><svg role="img" aria-label="github logo" viewBox="0 0 16 16" width="16px" height="16px"><title>github logo</title><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">jyn514</span></a>
          </li>
          

          

          

          
          <li>
            <a href="https://www.linkedin.com/in/jynelson514">
              <span class="icon icon--linkedin"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!-- Created with Inkscape (http://www.inkscape.org/) -->

<svg
   xmlns:dc="http://purl.org/dc/elements/1.1/"
   xmlns:cc="http://creativecommons.org/ns#"
   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
   xmlns:svg="http://www.w3.org/2000/svg"
   xmlns="http://www.w3.org/2000/svg"
   xmlns:xlink="http://www.w3.org/1999/xlink"
   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
   version="1.1"
   role="img"
   aria-label="LinkedIn logo"
   width="16"
   height="16"
   viewBox="0 0 16 16"
   sodipodi:docname="icon-linkedin.svg"
   inkscape:version="0.92.1 r15371">
  <title>LinkedIn logo</title>
  <metadata>
    <rdf:RDF>
      <cc:Work
         rdf:about="">
        <dc:format>image/svg+xml</dc:format>
        <dc:type
           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />
        <dc:title>LinkedIn logo</dc:title>
        <cc:license
           rdf:resource="http://creativecommons.org/licenses/by-sa/4.0/" />
      </cc:Work>
      <cc:License
         rdf:about="http://creativecommons.org/licenses/by-sa/4.0/">
        <cc:permits
           rdf:resource="http://creativecommons.org/ns#Reproduction" />
        <cc:permits
           rdf:resource="http://creativecommons.org/ns#Distribution" />
        <cc:requires
           rdf:resource="http://creativecommons.org/ns#Notice" />
        <cc:requires
           rdf:resource="http://creativecommons.org/ns#Attribution" />
        <cc:permits
           rdf:resource="http://creativecommons.org/ns#DerivativeWorks" />
        <cc:requires
           rdf:resource="http://creativecommons.org/ns#ShareAlike" />
      </cc:License>
    </rdf:RDF>
  </metadata>
  <sodipodi:namedview
     pagecolor="#ffffff"
     bordercolor="#666666"
     borderopacity="1"
     objecttolerance="10"
     gridtolerance="10"
     guidetolerance="10"
     inkscape:pageopacity="0"
     inkscape:pageshadow="2"
     inkscape:window-width="667"
     inkscape:window-height="429"
     showgrid="false"
     inkscape:zoom="4"
     inkscape:cx="1.6884357e-08"
     inkscape:cy="-8"
     inkscape:window-x="182"
     inkscape:window-y="326"
     inkscape:window-maximized="0"
     inkscape:current-layer="svg2" />
  <image
     width="16"
     height="16"
     preserveAspectRatio="none"
     style="image-rendering:optimizeQuality"
     xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAABHNCSVQICAgIfAhkiAAAAydJREFU eJztmz9MGlEcx7/vghY6gJbBQEmKJl3aREgYbKJGhk6dTIhjUybHykQ76tYwMbsUJ4emqUPbyQET GRxIpUnbgQTP5CJxwEMHz3/xdbiYatJ67+jJ78HdZ4T33n3f53jv3nvhGAAg/zEGDBYANgPGouhn ON8D+AZwlkchozGz8/dqYOwBdbauwnkLOE0qwGDBdZ0HAMbCwGBBAViaOgsdbEYBYxHqGGQwFlWo M1DjCaAOQI3rBfhECw4FBpCbjCM3NYqQ36x2eHKB4uYOihUVbeP8zkLeJQxvvnCrQkOBAZTnJ5CI BP/6fa15hPTyVk9KsBwCVp0HgEQkiPL8BIYCA46G6waWAnKT8Vs7f0UiEkRuMu5Epq5iLWBqVLgx O2VlwVLA1YQnQsjv67lh4PhjsNcmQksBhycXwo3ZKSsLlgKKmzvCjdkpKwvWAioqas0jy4ZqzSMU K6oTmbqKpYC2cY708tatEvp6IQT8kbC0Xr8xzg9PLrC0Xu/ZzgOCS+F+xvW7QdcLEF/mEZAeCyOb eoj48H3MjJkH17u6AVU3oOrHKDcOsPZz/7/mH6E5gL97IdbY268d179eNxkNojQ3LrQJA4CVqobF 9TpU3RAqfx3phkA2FcO311PCnQeAV6kYthemMft0xPb1pBKQTcXwfm68o7ohvw+fXqaQjIqLAyQS kB4Ld9z565Tnn9nakUojoORA5wHzl2DnYEYaAY+GA461ZedgRhoBThLy+4QnxL4UAJhzighSLoQ2 GgcoVnaw9mMfgHkyPftkBIvPHwsPlaTgY1Q6AStVDdkP32981jbOUapqKDda2F6YFjqnFH0cSjUE dnUDuc+//vm9qhsoVTWhtkQPc6USILKuvxoWTiGVgHKj1fVrSiWgbVifKqv6saPXlEqACJ3s+G5D KgFO310RJBPg7N0VQSoBFHgCqANQ4wmgDkCNJ4A6ADWeAOoA1HgCqANQ4wmgDkCN6wV4f5GhDkCN J4A6ADWK+S6tS+F8TzFfJHYrfEMBzvLg/IA6StfhvAWc5RUUMhpwmgC/XAXnTepcdw7nTfDLVeA0 iUJG+w1B+v3Clyog6wAAAABJRU5ErkJggg== "
     id="image10"
     x="0"
     y="0" />
</svg>
</span>
              <span class="username">jynelson514</span>
            </a>
          </li>
          

        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>i write about code, and things that bring me joy, and sometimes other things too</p>
      </div>
    </div>

  </div>

</footer>

</body>
</html>
