<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Building Docs.rs</title>
    <meta name="description" content="How I because the 2nd-most prolific contributor to docs.rs">
    <meta name="author" content="jyn">

    <link rel="alternate" type="application/atom+xml" title="the website of jyn" href="/atom.xml">
    <link rel="icon" type="image/x-icon" href="https://jyn.dev/favicon.jpg">
    <script src="/main.js?v=wvtZiifuphFXrUx&#x2F;AZPby7lFReedssGrex4iXTQVPxDX5pADGkCUoT7Z3AHQD2sE" defer></script>
    <link rel="stylesheet" href="https://jyn.dev/minima.css?v=PbArlSoyRf+X9Tyb3lhhFoVxQSXIbhQdDcqszhAQQHbQWoYLtrcqLij&#x2F;46wgTFlJ">
</head>
<body>
      <header class="site-header" role="banner">

      <div class="wrapper">
        <a class="site-title" href="/">the website of jyn</a>

        
        
          <nav class="site-nav">
            <input type="checkbox" id="nav-trigger" class="nav-trigger" />
            <label for="nav-trigger">
              <span class="menu-icon">
                <svg viewBox="0 0 18 15" width="18px" height="15px">
                  <title>menu</title>
                  <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
                  <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
                  <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
                </svg>
              </span>
            </label>

            <div class="trigger">
              
                
                
                <a class="page-link" href="&#x2F;about&#x2F;">about</a>
                
              
                
                
              
                
                
                <a class="page-link" href="&#x2F;talks&#x2F;">talks</a>
                
              
                <a class="page-link" href="/computer-of-the-future">the computer of the next 200 years</a>
            </div>
          </nav>
        
      </div>
    </header>

    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
		<h1 title="How I because the 2nd-most prolific contributor to docs.rs" class="post-title" itemprop="name headline">Building Docs.rs</h1>
    <p class="post-meta">
      <time datetime="2019-11-26" itemprop="datePublished">
        2019-11-26
      </time>
      
      
      
        
        
      • <a href="https://jyn.dev/tags/stories/">stories</a>
        
      • <a href="https://jyn.dev/tags/rust/">rust</a>
        
      
    </p>
  </header>

  

	

  
    

  <div class="post-content" itemprop="articleBody">
    <h2 id="what-is-docs-rs">What is docs.rs?<a class="zola-anchor" href="#what-is-docs-rs" aria-label="Anchor link for: what-is-docs-rs"></a>
</h2>
<p><a href="https://docs.rs/">docs.rs</a> is a site dedicated to hosting documentation for Rust projects.
It automatically builds documentation for every package published to
<a href="https://crates.io/">crates.io</a> using <code>cargo</code> and <code>rustdoc</code>.
Unfortunately, because <code>rustdoc</code> is tied so closely to the compiler,
this requires building every package from source using <code>cargo doc</code>.
As a result, I've heard several members of the docs.rs team describe it as
'Remote Code Execution as a Service' (since <code>build.rs</code> files can
<a href="https://doc.rust-lang.org/cargo/reference/build-scripts.html">execute arbitrary code</a>).</p>
<p>Just from this description you can see that hosting docs.rs is an enormous job
and requires a ton of compute resources. It gets worse when you consider that
docs.rs has to <em>store</em> all this documentation somewhere. In fact, it's in
an AWS storage bucket and gets uploaded after every build.</p>
<h2 id="how-did-i-get-involved">How did I get involved?<a class="zola-anchor" href="#how-did-i-get-involved" aria-label="Anchor link for: how-did-i-get-involved"></a>
</h2>
<p>My main rust project is <a href="https://github.com/jyn514/rcc">rcc</a>, a C compiler written in Rust.
I use <a href="https://github.com/CraneStation/cranelift">Cranelift</a> to generate the assembly
code; Cranelift is a code generator like <a href="https://llvm.org/">LLVM</a>.
Cranelift releases very quickly - I first started using it in version
<a href="https://github.com/jyn514/rcc/commit/9f5573d"><code>0.36</code></a> and it's currently on
<a href="https://docs.rs/cranelift-codegen/0.51.0/cranelift_codegen/"><code>0.51</code></a>.
Because I used the docs so much when I was getting started,
Firefox got convinced that I always wanted to visit <code>0.36</code> - see also the
<a href="https://github.com/rust-lang/rust/issues/9461">rustdoc issue</a> about canonical URLs.</p>
<p>Fortunately, docs.rs has a little link you can click to go to the latest version.
Unfortunately, docs.rs used to redirect you to the home page whenever you clicked that link,
so if you were looking up
<a href="https://docs.rs/cranelift-codegen/0.42.0/cranelift_codegen/ir/trait.InstBuilder.html"><code>cranelift_codegen::ir::InstBuilder</code></a>
before, you'd have to click through 3 links to get back there on the latest version.
This has made a lot of people very angry and been widely regarded as a bad move.
There had actually been <a href="https://github.com/rust-lang/docs.rs/issues/200">an issue open</a>
for about a year and a half at this point, although it wasn't getting much attention.</p>
<p>I decided since I was running into the issue so much, I may as well contribute a patch.</p>
<h2 id="what-happened">What happened?<a class="zola-anchor" href="#what-happened" aria-label="Anchor link for: what-happened"></a>
</h2>
<p>At that point, docs.rs was using <a href="https://www.vagrantup.com/">Vagrant</a> to run
builds locally, because it needed to have a sandboxed environment to execute
arbitrary code on. When I tried using it, it took about 20 minutes and then I
<a href="https://github.com/rust-lang/docs.rs/issues/200#issuecomment-539771094">got an ugly error</a> without any explanation.
Remember, this isn't even the hard part of the change, I just wanted to get it running from master.</p>
<p>I chatted with <a href="https://github.com/pietroalbini">Pietro</a> on Discord
and it turns out that docs.rs had recently
<a href="https://github.com/rust-lang/docs.rs/pull/407">switched to a different sandbox</a>,
but the Vagrantfile never got updated. Since I don't know really how to use Vagrant
or Ruby (and no one was volunteering to fix it), I didn't have any hope of getting
that working. I asked what I could do and someone pointed me to
<a href="https://github.com/rust-lang/docs.rs/wiki/Self-hosting-outside-the-Vagrant-VM">the wiki</a>.
I took one look and knew there was no way I wanted to do this - it's about 5 pages,
and 30 manually steps, most of which have to be done in order.
So I figured, hey, I'm a developer, let's automate this!</p>
<p>Long story short, I ended up <a href="https://github.com/rust-lang/docs.rs/pull/432">writing a <code>Dockerfile</code></a>
and Pietro was so impressed that he started <a href="https://github.com/rust-lang/docs.rs/pull/455">using it in production</a> :D</p>
<p>After a month and what has been called</p>
<blockquote>
<p><a href="https://users.rust-lang.org/t/rust-2020-growth/34956/43">Unprecedented (but greatly appreciated) levels of yak shaving</a></p>
</blockquote>
<p>I finally <a href="https://github.com/rust-lang/docs.rs/pull/454">got the original change merged</a> :)</p>
<h2 id="what-next">What next?<a class="zola-anchor" href="#what-next" aria-label="Anchor link for: what-next"></a>
</h2>
<p>Pietro and <a href="https://github.com/QuietMisdreavus">QuietMisdreavus</a> were so impressed
with my work that they invited me to the team! As of November 1st, I have push access
to <code>docs.rs</code> :) (Pietro still handles the deploys)</p>
<p>I've been helping with <a href="https://github.com/rust-lang/docs.rs/pull/487">a</a>
<a href="https://github.com/rust-lang/docs.rs/pull/485">few</a>
<a href="https://github.com/rust-lang/docs.rs/pull/476">other</a>
<a href="https://github.com/rust-lang/docs.rs/pull/468">PRs</a>
<a href="https://github.com/rust-lang/docs.rs/pull/460">since</a>
and plan to contribute for the foreseeable future!</p>
<h2 id="acknowledgments">Acknowledgments<a class="zola-anchor" href="#acknowledgments" aria-label="Anchor link for: acknowledgments"></a>
</h2>
<p>Thank you so much to Pietro and QuietMisdreavus for helping me get started with
the project! My favorite part of working on docs.rs is giving and receiving feedback
from my friends.</p>
<p>Thank you to <a href="https://users.rust-lang.org/u/17cupsofcoffee">/u/17cupsofcoffee</a>
for prompting me to write this blog post!</p>
<p>And finally, thanks to everyone in the Rust community for making this an awesome
language to work on :D</p>

  </div>
</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading"><a href="https://jyn.dev">the website of jyn</a></h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
            
            <li><a href="mailto:blog@jyn.dev">blog@jyn.dev</a></li>
            
            
            <li><a href="https://jyn.dev/assets/Resume.pdf">Resume</a>

        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/jyn514"><span class="icon icon--github"><svg role="img" aria-label="github logo" viewBox="0 0 16 16" width="16px" height="16px"><title>github logo</title><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">jyn514</span></a>
          </li>
          

          

          

          
          <li>
            <a href="https://www.linkedin.com/in/jynelson514">
              <span class="icon icon--linkedin"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!-- Created with Inkscape (http://www.inkscape.org/) -->

<svg
   xmlns:dc="http://purl.org/dc/elements/1.1/"
   xmlns:cc="http://creativecommons.org/ns#"
   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
   xmlns:svg="http://www.w3.org/2000/svg"
   xmlns="http://www.w3.org/2000/svg"
   xmlns:xlink="http://www.w3.org/1999/xlink"
   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
   version="1.1"
   role="img"
   aria-label="LinkedIn logo"
   width="16"
   height="16"
   viewBox="0 0 16 16"
   sodipodi:docname="icon-linkedin.svg"
   inkscape:version="0.92.1 r15371">
  <title>LinkedIn logo</title>
  <metadata>
    <rdf:RDF>
      <cc:Work
         rdf:about="">
        <dc:format>image/svg+xml</dc:format>
        <dc:type
           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />
        <dc:title>LinkedIn logo</dc:title>
        <cc:license
           rdf:resource="http://creativecommons.org/licenses/by-sa/4.0/" />
      </cc:Work>
      <cc:License
         rdf:about="http://creativecommons.org/licenses/by-sa/4.0/">
        <cc:permits
           rdf:resource="http://creativecommons.org/ns#Reproduction" />
        <cc:permits
           rdf:resource="http://creativecommons.org/ns#Distribution" />
        <cc:requires
           rdf:resource="http://creativecommons.org/ns#Notice" />
        <cc:requires
           rdf:resource="http://creativecommons.org/ns#Attribution" />
        <cc:permits
           rdf:resource="http://creativecommons.org/ns#DerivativeWorks" />
        <cc:requires
           rdf:resource="http://creativecommons.org/ns#ShareAlike" />
      </cc:License>
    </rdf:RDF>
  </metadata>
  <sodipodi:namedview
     pagecolor="#ffffff"
     bordercolor="#666666"
     borderopacity="1"
     objecttolerance="10"
     gridtolerance="10"
     guidetolerance="10"
     inkscape:pageopacity="0"
     inkscape:pageshadow="2"
     inkscape:window-width="667"
     inkscape:window-height="429"
     showgrid="false"
     inkscape:zoom="4"
     inkscape:cx="1.6884357e-08"
     inkscape:cy="-8"
     inkscape:window-x="182"
     inkscape:window-y="326"
     inkscape:window-maximized="0"
     inkscape:current-layer="svg2" />
  <image
     width="16"
     height="16"
     preserveAspectRatio="none"
     style="image-rendering:optimizeQuality"
     xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAABHNCSVQICAgIfAhkiAAAAydJREFU eJztmz9MGlEcx7/vghY6gJbBQEmKJl3aREgYbKJGhk6dTIhjUybHykQ76tYwMbsUJ4emqUPbyQET GRxIpUnbgQTP5CJxwEMHz3/xdbiYatJ67+jJ78HdZ4T33n3f53jv3nvhGAAg/zEGDBYANgPGouhn ON8D+AZwlkchozGz8/dqYOwBdbauwnkLOE0qwGDBdZ0HAMbCwGBBAViaOgsdbEYBYxHqGGQwFlWo M1DjCaAOQI3rBfhECw4FBpCbjCM3NYqQ36x2eHKB4uYOihUVbeP8zkLeJQxvvnCrQkOBAZTnJ5CI BP/6fa15hPTyVk9KsBwCVp0HgEQkiPL8BIYCA46G6waWAnKT8Vs7f0UiEkRuMu5Epq5iLWBqVLgx O2VlwVLA1YQnQsjv67lh4PhjsNcmQksBhycXwo3ZKSsLlgKKmzvCjdkpKwvWAioqas0jy4ZqzSMU K6oTmbqKpYC2cY708tatEvp6IQT8kbC0Xr8xzg9PLrC0Xu/ZzgOCS+F+xvW7QdcLEF/mEZAeCyOb eoj48H3MjJkH17u6AVU3oOrHKDcOsPZz/7/mH6E5gL97IdbY268d179eNxkNojQ3LrQJA4CVqobF 9TpU3RAqfx3phkA2FcO311PCnQeAV6kYthemMft0xPb1pBKQTcXwfm68o7ohvw+fXqaQjIqLAyQS kB4Ld9z565Tnn9nakUojoORA5wHzl2DnYEYaAY+GA461ZedgRhoBThLy+4QnxL4UAJhzighSLoQ2 GgcoVnaw9mMfgHkyPftkBIvPHwsPlaTgY1Q6AStVDdkP32981jbOUapqKDda2F6YFjqnFH0cSjUE dnUDuc+//vm9qhsoVTWhtkQPc6USILKuvxoWTiGVgHKj1fVrSiWgbVifKqv6saPXlEqACJ3s+G5D KgFO310RJBPg7N0VQSoBFHgCqANQ4wmgDkCNJ4A6ADWeAOoA1HgCqANQ4wmgDkCN6wV4f5GhDkCN J4A6ADWK+S6tS+F8TzFfJHYrfEMBzvLg/IA6StfhvAWc5RUUMhpwmgC/XAXnTepcdw7nTfDLVeA0 iUJG+w1B+v3Clyog6wAAAABJRU5ErkJggg== "
     id="image10"
     x="0"
     y="0" />
</svg>
</span>
              <span class="username">jynelson514</span>
            </a>
          </li>
          

        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>i write about code, and things that bring me joy, and sometimes other things too</p>
      </div>
    </div>

  </div>

</footer>

</body>
</html>
